<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <script>
        // 获取验证码
        function fetchVerificationCode() {
            const studentId = document.querySelector("input[name='id']").value;

            if (!studentId) {
                alert("请输入学号");
                return;
            }

            fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: parseInt(studentId) })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应异常');
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message || '验证码已发送');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取验证码失败');
                });
        }

        // 表单提交前可做校验（可选）
        function validateForm(event) {
            const studentId = document.querySelector("input[name='id']").value;
            const code = document.querySelector("input[name='code']").value;

            if (!studentId) {
                alert("请输入学号");
                event.preventDefault();
                return false;
            }

            if (!code) {
                alert("请输入验证码");
                event.preventDefault();
                return false;
            }

            return true;
        }

        function submitLoginForm() {
            const studentId = document.querySelector("input[name='id']").value;
            const code = document.querySelector("input[name='code']").value;

            if (!studentId) {
                alert("请输入学号");
                return;
            }

            if (!code) {
                alert("请输入验证码");
                return;
            }

            // 先验证验证码
            fetch('/api/login/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code: code })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应异常');
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message || '验证成功');

                    // 验证通过后跳转到 forum.html
                    window.location.href = "/forum/forum.html";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('验证码错误或验证失败');
                });
        }

        // 绑定表单提交事件
        window.onload = function () {
            const form = document.querySelector("form");
            form.addEventListener("submit", function (event) {
                validateForm(event);
            });
        };
    </script>
</head>

<body>
<h1>登录</h1>
<img src="/favicon.jpg" alt="Favicon">

<form action="/login" method="post">
    学号：<input type="text" name="id"><br>
    验证码：<input type="text" name="code"><br>
    <input type="button" id="getCodeBtn" value="获取验证码" onclick="fetchVerificationCode()">
    <input type="button" value="登录" onclick="submitLoginForm()">
</form>
</body>
</html>
