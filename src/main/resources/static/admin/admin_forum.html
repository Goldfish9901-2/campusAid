<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusAid - ç®¡ç†è®ºå›</title>
  <link rel="icon" href="/favicon.jpg" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      padding: 20px;
      background-color: #f4f4f9;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }

    .search-select,
    .search-input,
    .search-button {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .search-button {
      background-color: #3399ff;
      color: white;
      border: none;
      cursor: pointer;
    }

    .search-button:hover {
      background-color: #2980b9;
    }

    .post-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .post-card {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
    }

    .post-card:hover {
      transform: scale(1.01);
    }

    .post-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0 0 8px;
    }

    .post-meta {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .post-content {
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
    }

    .post-actions {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 16px;
    }

    .view-reply {
      color: #3399ff;
      text-decoration: none;
      font-size: 14px;
      transition: color 0.3s ease;
    }

    .view-reply:hover {
      color: #0056b3;
    }

    .delete-link {
      color: red;
      text-decoration: none;
      font-size: 14px;
      transition: color 0.3s ease;
    }

    .delete-link:hover {
      color: darkred;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 6px 12px;
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }

    .pagination button:disabled {
      background-color: #e1e1e1;
      color: #aaa;
      cursor: not-allowed;
    }

    .page-info {
      font-size: 14px;
    }

    .page-jump input {
      width: 50px;
      padding: 4px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .page-jump button {
      padding: 4px 8px;
      background-color: #ddd;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .back-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .back-button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
<h1>ç®¡ç†å‘˜ - è®ºå›ç®¡ç†</h1>
<a href="/admin" class="back-button">è¿”å›</a>
<!-- æœç´¢åŒºåŸŸ -->
<div class="search-bar">
  <select id="search-type" class="search-select">
    <option value="TITLE">æ ‡é¢˜</option>
    <option value="CREATOR">å­¦å·</option>
    <option value="TAG">æ ‡ç­¾</option>
  </select>
  <input type="text" id="search-keyword" class="search-input" placeholder="è¯·è¾“å…¥å…³é”®è¯" />
  <button id="search-btn" class="search-button">ğŸ” æœç´¢</button>
</div>

<!-- å¸–å­åˆ—è¡¨ -->
<div class="post-list" id="post-list">
  <!-- å¸–å­å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
</div>

<!-- åˆ†é¡µæ  -->
<div class="pagination" id="pagination">
  <button id="prev-page" disabled>ä¸Šä¸€é¡µ</button>
  <span class="page-info">ç¬¬ <span id="current-page">1</span> é¡µ</span>
  <button id="next-page">ä¸‹ä¸€é¡µ</button>
  <div class="page-jump">
    <span>è·³è‡³</span>
    <input type="number" id="page-input" min="1" value="1" style="margin: 0 5px;" />
    <span>é¡µ</span>
    <button id="jump-btn">è·³è½¬</button>
  </div>
</div>

<script>
  const pagination = {
    currentPage: 0,
    hasMore: true,
    isLoading: false
  };

  const searchParams = {
    keyword: "",
    type: "TITLE"
  };

  document.addEventListener('DOMContentLoaded', function () {
    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    document.getElementById('search-btn').addEventListener('click', handleSearch);
    document.getElementById('prev-page').addEventListener('click', goPrevPage);
    document.getElementById('next-page').addEventListener('click', goNextPage);
    document.getElementById('jump-btn').addEventListener('click', jumpToPage);
    document.getElementById('page-input').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        jumpToPage();
      }
    });

    // åˆå§‹åŠ è½½
    loadPosts();
  });

  function handleSearch() {
    searchParams.keyword = document.getElementById('search-keyword').value.trim();
    searchParams.type = document.getElementById('search-type').value;
    pagination.currentPage = 0;
    pagination.hasMore = true;
    loadPosts();
  }

  function loadPosts() {
    if (pagination.isLoading) return;
    pagination.isLoading = true;

    const { keyword, type } = searchParams;
    const page = pagination.currentPage;

    fetch(`/api/forum/posts?keyword=${encodeURIComponent(keyword)}&type=${type}&page=${page}`, {
      method: 'GET',
      credentials: 'include'
    })
            .then(response => {
              if (!response.ok) throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
              return response.json();
            })
            .then(posts => {
              pagination.isLoading = false;
              if (posts.length < 10) pagination.hasMore = false;
              renderPosts(posts);
              updatePaginationUI();
            })
            .catch(error => {
              pagination.isLoading = false;
              console.error("è·å–å¸–å­å¤±è´¥:", error);
              document.getElementById("post-list").innerHTML = "<p>åŠ è½½å¸–å­æ—¶å‡ºé”™</p>";
            });
  }

  function renderPosts(posts) {
    const postList = document.getElementById("post-list");
    postList.innerHTML = "";

    if (posts.length === 0) {
      postList.innerHTML = "<p>æš‚æ— å¸–å­</p>";
      return;
    }

    posts.forEach(post => {
      const card = document.createElement("div");
      card.className = "post-card";

      card.innerHTML = `
                    <div class="post-title">${post.title}</div>
                    <div class="post-meta">ä½œè€…ï¼š${post.authorId} â€¢ æ—¶é—´ï¼š${formatTime(post.publishTime)}</div>
                    <div class="post-content">${truncateText(post.content, 50)}</div>
                    <div class="post-actions">
                        <a href="/forum/reply?postId=${post.postId}" target="_blank" class="view-reply">æŸ¥çœ‹å›å¤ (${post.replyCount})</a>
                        <a href="#" onclick="deletePost(${post.postId}); return false;" class="delete-link">åˆ é™¤å¸–å­</a>
                    </div>
                `;

      postList.appendChild(card);
    });
  }

  function formatTime(timeStr) {
    return timeStr ? timeStr.replace("T", " ").substring(0, 16) : "";
  }

  function truncateText(text, maxLength) {
    return text && text.length > maxLength ? text.substring(0, maxLength) + "..." : text;
  }

  function updatePaginationUI() {
    document.getElementById('current-page').textContent = pagination.currentPage + 1;
    document.getElementById('page-input').value = pagination.currentPage + 1;
    document.getElementById('prev-page').disabled = pagination.currentPage === 0;
    document.getElementById('next-page').disabled = !pagination.hasMore;
  }

  function goPrevPage() {
    if (pagination.currentPage > 0) {
      pagination.currentPage--;
      loadPosts();
    }
  }

  function goNextPage() {
    if (pagination.hasMore) {
      pagination.currentPage++;
      loadPosts();
    }
  }

  function jumpToPage() {
    const pageInput = document.getElementById('page-input');
    let targetPage = parseInt(pageInput.value) - 1; // è½¬ä¸º 0-based index

    if (isNaN(targetPage) || targetPage < 0) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ');
      return;
    }

    if (targetPage !== pagination.currentPage) {
      pagination.currentPage = targetPage;
      loadPosts();
    }
  }

  function deletePost(postId) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤å¸–å­ ID ä¸º ${postId} çš„å¸–å­å—ï¼Ÿ`)) {
      return;
    }

    fetch(`/api/forum/post/${postId}`, {
      method: 'DELETE',
      credentials: 'include'
    })
            .then(response => {
              if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
              return response.text();
            })
            .then(() => {
              alert('åˆ é™¤æˆåŠŸ');
              loadPosts(); // åˆ·æ–°æ•°æ®
            })
            .catch(err => {
              alert('åˆ é™¤å¤±è´¥: ' + err.message);
            });
  }
</script>
</body>
</html>
