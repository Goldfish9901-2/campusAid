<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CampusAid-帖子管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            animation: fadein 1.5s ease-in-out forwards;
        }

        @keyframes fadein {
            from {
                opacity: 0.2;
            }
            to {
                opacity: 1;
            }
        }

        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .post-container {
            max-width: 700px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }

        .post-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .post-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .post-content {
            font-size: 15px;
            color: #333;
            line-height: 1.6;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .replies-title {
            font-size: 18px;
            margin: 25px 0 15px;
            color: #333;
        }

        .replies-container {
            max-height: 450px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .reply-card {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            background-color: #f9f9f9;
            margin-bottom: 12px;
        }

        .reply-card strong {
            font-size: 15px;
            color: #333;
        }

        .reply-card small {
            font-size: 13px;
            color: #999;
            display: block;
            margin-top: 5px;
        }

        .back-button {
            border: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background-color: #0056b3;
        }

        .no-replies {
            color: #999;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
<button class="back-button" onclick="window.location.href='/admin/admin_forum'"><strong>返回</strong></button>
<div class="content-wrapper">
    <div class="post-container">
        <div id="post-detail">
        </div>
        <h3 class="replies-title">全部回复</h3>
        <div id="replies-container" class="replies-container"></div>
    </div>
</div>
<script>
    let currentUserId = null;

    fetch('/api/user', {
        method: 'GET',
        credentials: 'include'
    })
        .then(response => {
            if (!response.ok) throw new Error('获取用户信息失败');
            return response.json();
        })
        .then(user => {
            currentUserId = user.id || user.userId;
        })
        .catch(error => {
            console.error('获取用户信息失败:', error);
            alert('请先登录');
        });

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('postId');
    if (!postId) {
        document.getElementById('post-detail').innerHTML = '<p>未指定帖子ID</p>';
        throw new Error("缺少 postId");
    }
    fetch(`/api/forum/post/${postId}`, {
        method: 'GET',
        credentials: 'include'
    })
        .then(response => {
            if (!response.ok) throw new Error('获取帖子失败');
            return response.json();
        })
        .then(post => {
            renderPost(post);
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById('post-detail').innerHTML = `<p>加载帖子时出错：${error.message}</p>`;
        });
    function loadReplies() {
        fetch(`/api/forum/post/${postId}/replies`, {
            method: 'GET',
            credentials: 'include'
        })
            .then(response => {
                console.log('Response status:', response.status);
                if (response.status === 404) return [];

                if (!response.ok) throw new Error('获取回复失败');
                return response.json();
            })
            .then(replies => {
                renderReplies(replies || []);
            })
            .catch(error => {
                console.error("获取回复失败:", error);
                document.getElementById('replies-container').innerHTML =
                    `<p class="no-replies">加载回复失败：${error.message}</p>`;
            });
    }
    loadReplies();

    function renderPost(post) {
        console.log('当前帖子数据:', post);
        const container = document.getElementById('post-detail');
        container.innerHTML = `
        <h1 class="post-title">${post.title}</h1>
        <div class="post-meta">作者：${post.authorId} • 时间：${formatTime(post.publishTime)}</div>
        <div class="post-content">${post.content}</div>
    `;
    }
    function renderReplies(replies) {
        console.log('当前回复数据:', replies);
        const container = document.getElementById('replies-container');
        container.innerHTML = '';
        if (replies.length === 0) {
            container.innerHTML = '<p class="no-replies">暂无回复</p>';
            return;
        }
        replies.forEach(reply => {
            const replyCard = document.createElement('div');
            replyCard.className = 'reply-card';

            replyCard.innerHTML = `
            <strong>${reply.senderId}：</strong>
            <div>${reply.content}</div>
            <small>${formatTime(reply.sendTime)}</small>
            <a href="javascript:void(0)" class="delete-link" data-reply-id="${reply.id}"> 删除</a>
        `;
            container.appendChild(replyCard);

            const deleteLink = replyCard.querySelector('.delete-link');
            deleteLink.addEventListener('click', function () {
                const replyId = this.getAttribute('data-reply-id');
                deleteReply(replyId);
            });
        });
    }

    function formatTime(timeStr) {
        return timeStr ? timeStr.replace("T", " ").substring(0, 16) : "";
    }

    function deleteReply(replyId) {
        if (!confirm('确定要删除这条回复吗？')) return;

        fetch(`/api/forum/reply/${replyId}`, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`服务器响应：${text}`);
                    });
                }
                return response.text();
            })
            .then(() => {
                alert('回复已删除');
                loadReplies(); // 刷新回复列表
            })
            .catch(error => {
                console.error('删除时发生错误:', error);
                alert('删除失败：' + error.message);
            });
    }
</script>
</body>
</html>